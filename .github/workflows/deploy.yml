# Gaming Platform CI/CD Pipeline
name: Deploy Gaming Platform

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

jobs:
  # æ£€æµ‹å˜æ›´çš„æœåŠ¡
  changes:
    runs-on: ubuntu-latest
    outputs:
      root: ${{ steps.changes.outputs.root }}
      api: ${{ steps.changes.outputs.api }}
      home: ${{ steps.changes.outputs.home }}
      games: ${{ steps.changes.outputs.games }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            root:
              - 'gaming-platform-root/**'
            api:
              - 'gaming-platform-api/**'  
            home:
              - 'gaming-platform-home/**'
            games:
              - 'gaming-platform-games/**'

  # æ„å»º Root åº”ç”¨
  build-root:
    needs: changes
    if: ${{ needs.changes.outputs.root == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'gaming-platform-root/package-lock.json'
      
      - name: Install dependencies
        run: |
          cd gaming-platform-root
          npm ci
      
      - name: Build
        run: |
          cd gaming-platform-root
          npm run build
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: root-dist
          path: gaming-platform-root/dist/

  # æ„å»º API æœåŠ¡
  build-api:
    needs: changes
    if: ${{ needs.changes.outputs.api == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'gaming-platform-api/package-lock.json'
      
      - name: Install dependencies
        run: |
          cd gaming-platform-api
          npm ci
      
      - name: Build
        run: |
          cd gaming-platform-api
          npm run build
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: api-dist
          path: gaming-platform-api/dist/

  # æ„å»º Home æœåŠ¡
  build-home:
    needs: changes
    if: ${{ needs.changes.outputs.home == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'gaming-platform-home/package-lock.json'
      
      - name: Install dependencies
        run: |
          cd gaming-platform-home
          npm ci
      
      - name: Build
        run: |
          cd gaming-platform-home
          npm run build
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: home-dist
          path: gaming-platform-home/dist/

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: [changes, build-root, build-api, build-home]
    if: |
      always() && 
      (needs.build-root.result == 'success' || needs.build-root.result == 'skipped') &&
      (needs.build-api.result == 'success' || needs.build-api.result == 'skipped') &&
      (needs.build-home.result == 'success' || needs.build-home.result == 'skipped')
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v3
      
      # ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download root artifacts
        if: ${{ needs.changes.outputs.root == 'true' }}
        uses: actions/download-artifact@v3
        with:
          name: root-dist
          path: ./deploy/root/
      
      - name: Download API artifacts  
        if: ${{ needs.changes.outputs.api == 'true' }}
        uses: actions/download-artifact@v3
        with:
          name: api-dist
          path: ./deploy/api/
      
      - name: Download Home artifacts
        if: ${{ needs.changes.outputs.home == 'true' }}
        uses: actions/download-artifact@v3
        with:
          name: home-dist
          path: ./deploy/home/
      
      # éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p /var/www/gaming-platform
            sudo mkdir -p /var/www/gaming-platform-api
            sudo mkdir -p /var/www/gaming-platform-home
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            sudo cp -r /var/www/gaming-platform /var/backups/gaming-platform-$(date +%Y%m%d_%H%M%S) || true
            
            # æ›´æ–°ä»£ç  (è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´)
            cd /path/to/your/repos
            git pull origin main
            
            # è¿è¡Œéƒ¨ç½²è„šæœ¬
            sudo ./deploy.sh deploy
            
            # é‡å¯ Nginx
            sudo systemctl reload nginx
            
            # å¥åº·æ£€æŸ¥
            sleep 5
            curl -f http://localhost/health || exit 1

  # é€šçŸ¥
  notify:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify success
        if: ${{ needs.deploy.result == 'success' }}
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          # è¿™é‡Œå¯ä»¥é›†æˆ Slackã€ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥
      
      - name: Notify failure
        if: ${{ needs.deploy.result == 'failure' }}
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥!"
          # è¿™é‡Œå¯ä»¥é›†æˆé”™è¯¯é€šçŸ¥